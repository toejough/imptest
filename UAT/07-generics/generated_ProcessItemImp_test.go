// Code generated by impgen. DO NOT EDIT.

package generics_test

import (
	generics "github.com/toejough/imptest/UAT/07-generics"
	"github.com/toejough/imptest/imptest"
	"testing"
)

type ProcessItemImpReturn[T any] struct {
	Result0 error
}

type ProcessItemImp[T any] struct {
	*imptest.CallableController[ProcessItemImpReturn[T]]
	callable func(repo generics.Repository[T], id string, transformer func(T) T) error
}

func NewProcessItemImp[T any](t testing.TB, callable func(repo generics.Repository[T], id string, transformer func(T) T) error) *ProcessItemImp[T] {
	return &ProcessItemImp[T]{
		CallableController: imptest.NewCallableController[ProcessItemImpReturn[T]](t),
		callable:           callable,
	}
}

func (s *ProcessItemImp[T]) Start(repo generics.Repository[T], id string, transformer func(T) T) *ProcessItemImp[T] {
	go func() {
		defer func() {
			if r := recover(); r != nil {
				s.PanicChan <- r
			}
		}()

		ret0 := s.callable(repo, id, transformer)
		s.ReturnChan <- ProcessItemImpReturn[T]{
			Result0: ret0,
		}
	}()
	return s
}

func (s *ProcessItemImp[T]) ExpectReturnedValuesAre(v1 error) {
	s.T.Helper()
	s.WaitForResponse()

	if s.Returned != nil {
		if s.Returned.Result0 != v1 {
			s.T.Fatalf("expected return value 0 to be %v, got %v", v1, s.Returned.Result0)
		}
		return
	}

	s.T.Fatalf("expected function to return, but it panicked with: %v", s.Panicked)
}

func (s *ProcessItemImp[T]) ExpectReturnedValuesShould(v1 any) {
	s.T.Helper()
	s.WaitForResponse()

	if s.Returned != nil {
		var ok bool
		var msg string
		ok, msg = imptest.MatchValue(s.Returned.Result0, v1)
		if !ok {
			s.T.Fatalf("return value 0: %s", msg)
		}
		return
	}

	s.T.Fatalf("expected function to return, but it panicked with: %v", s.Panicked)
}

func (s *ProcessItemImp[T]) ExpectPanicWith(expected any) {
	s.T.Helper()
	s.WaitForResponse()

	if s.Panicked != nil {
		ok, msg := imptest.MatchValue(s.Panicked, expected)
		if !ok {
			s.T.Fatalf("panic value: %s", msg)
		}
		return
	}

	s.T.Fatalf("expected function to panic, but it returned")
}

type ProcessItemImpResponse[T any] struct {
	EventType string // "return" or "panic"
	ReturnVal *ProcessItemImpReturn[T]
	PanicVal  any
}

func (r *ProcessItemImpResponse[T]) Type() string {
	return r.EventType
}

func (r *ProcessItemImpResponse[T]) AsReturn() []any {
	if r.ReturnVal == nil {
		return nil
	}
	return []any{r.ReturnVal.Result0}
}

func (s *ProcessItemImp[T]) GetResponse() *ProcessItemImpResponse[T] {
	s.WaitForResponse()

	if s.Returned != nil {
		return &ProcessItemImpResponse[T]{
			EventType: "ReturnEvent",
			ReturnVal: s.Returned,
		}
	}

	return &ProcessItemImpResponse[T]{
		EventType: "PanicEvent",
		PanicVal:  s.Panicked,
	}
}
